---
---
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Minhas Exibições</title>

  {% include headPadrao.html %}
  <script type="module" src="../js/verificaLogin.js"></script>

</head>

<body data-type="exibicoes">
  {% include header.html %}

  <div class="flex justify-center my-6">
    <h1 id="tituloH1" class="text-2xl font-roboto-mono font-bold">Gerenciar Exibições</h1>
  </div>

  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow p-6 overflow-x-auto">
    <table class="min-w-full table-auto border-collapse">
      <thead>
        <tr class="bg-gray-100 font-bold text-gray-700">
          <th class="py-3 px-6 text-center w-1/5">Código</th>
          <th class="py-3 px-6 text-center w-2/5">Nome</th>
          <th class="py-3 px-6 text-center w-2/5">Ações</th>
        </tr>
      </thead>
      
      <tbody id="tabelaLinkLinhas">
        <tr>
            <td colspan="3" class="text-center py-6 text-gray-500">Carregando...</td>
        </tr>
      </tbody>
    </table>
    
  </div>

  <script src="../js/userMenu.js"></script>
  <script src="../js/mobile-navbar.js"></script>
  
  <script type="module">
    import { iniciaAnim, fechaAnim, setTexto, setSubTexto, erroAnim, setSimNao } from '../js/loadingAnim.js';

    document.addEventListener('DOMContentLoaded', () => {
        const vercel = 'https://sistema-monitoramento-linhas-onibus.vercel.app';
        const token = localStorage.getItem('tokenLogin');
        const tabela = document.getElementById('tabelaLinkLinhas');

        // Função para carregar a lista
        async function carregarLista() {
            if (!token) {
                tabela.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-red-500">Faça login para ver suas exibições.</td></tr>';
                return;
            }

            try {
                const res = await fetch(`${vercel}/get-usuario-exibicoes`, {
                    headers: { 'X-Access-Token': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error('Erro ao buscar dados');

                const dados = await res.json();
                tabela.innerHTML = ''; // Limpa loading

                if (dados.length === 0) {
                    tabela.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Nenhuma exibição criada ainda.</td></tr>';
                    return;
                }

                // Cria as linhas da tabela
                dados.forEach(exib => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50 transition";
                    
                    const nomeExibicao = exib.nome_exibicao || '<span class="italic text-gray-400">Sem Nome</span>';

                    // --- AQUI ESTÃO OS BOTÕES INCLUINDO O DELETE ---
                    tr.innerHTML = `
                        <td class="py-3 px-6 text-center font-mono font-bold text-gray-600">${exib.codigo_exib}</td>
                        <td class="py-3 px-6 text-center font-medium text-lg">${nomeExibicao}</td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex justify-center gap-2">
                                <a href="exibicao.html?codigo=${exib.codigo_exib}" 
                                   class="px-3 py-2 bg-sptrans text-white rounded hover:bg-red-800 transition text-sm font-bold"
                                   title="Ver Exibição">
                                   <i class="fas fa-eye"></i> Ver
                                </a>

                                <a href="configuracao.html?editar=${exib.codigo_exib}" 
                                   class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm font-bold"
                                   title="Editar Configurações">
                                   <i class="fas fa-pen"></i> Editar
                                </a>

                                <button onclick="window.confirmarExclusao('${exib.codigo_exib}', '${exib.nome_exibicao || 'esta exibição'}')" 
                                   class="px-3 py-2 bg-gray-200 text-gray-600 rounded hover:bg-red-500 hover:text-white transition text-sm font-bold"
                                   title="Excluir">
                                   <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tabela.appendChild(tr);
                });

            } catch (erro) {
                console.error(erro);
                tabela.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-red-500">Erro ao carregar lista.</td></tr>';
            }
        }

        // Função de Deletar (Atrelada ao window para funcionar no onclick inline)
        window.confirmarExclusao = async function(codigo, nome) {
            const confirmacao = await setSimNao(`Excluir "${nome}"?`, "Cancelar");
            
            if (!confirmacao) return;

            iniciaAnim();
            setTexto("Excluindo...");

            try {
                const res = await fetch(`${vercel}/deletar-exibicao`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Token': `Bearer ${token}`
                    },
                    body: JSON.stringify({ codigo_exib: codigo })
                });

                if (res.ok) {
                    setTexto("Sucesso!");
                    setSubTexto("Exibição removida.");
                    setTimeout(() => {
                        fechaAnim();
                        carregarLista(); // Recarrega a tabela para sumir o item excluído
                    }, 1000);
                } else {
                    const erro = await res.json();
                    erroAnim();
                    setTexto("Erro");
                    setSubTexto(erro.error || "Falha ao excluir.");
                }
            } catch (e) {
                erroAnim();
                setTexto("Erro de conexão");
            }
        }

        // Inicia o carregamento
        carregarLista();
    });
  </script>

</body>
</html>